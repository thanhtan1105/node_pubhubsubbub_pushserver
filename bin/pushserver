#!/usr/bin/env node

'use strict';

const debug = require('debug')('pushserver:app');
const config = require('../lib/config');

debug('Loading web…');
const web = require('../lib/web');
const adminSections = {};

debug('Loading db…');
const db = require('../lib/db');
if (config.db.web) {
    adminSections.db = db.expressMiddleware();
}

debug('Loading push queue…');
const pushQueue = require('../lib/pushQueue');
const kue = require('kue');
const pushKue = kue.createQueue({
    disableSearch: true,
    jobEvents: false,
    redis: config.redis,
});
pushKue.watchStuckJobs(1000);
pushQueue.setup(
  pushKue,
  require('../lib/pusher').setup(
    require('apn'),
    require('node-gcm'),
    require('wns')
  ),
  db.projects,
  db.devices
);
if (config.pushQueue.web) {
    adminSections.queue = kue.app;
}

debug('Starting…');
web.start(config.web.port, db, pushQueue, adminSections);
